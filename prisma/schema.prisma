// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["mongoDb"]
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model log {
  id  String  @id @default(auto()) @map("_id") @db.ObjectId
  type String
  createdAt DateTime @default(now())
  content  Json
}


model users {
  id  String  @id @default(auto()) @map("_id") @db.ObjectId
  username String @unique
  password String
  hash String @unique

  // additional user information
  preferredName String?
  phone String?
  timezone String?

  // for group assignment
  gif Boolean? @default(false)
  salience Boolean? @default(false)
  modification Boolean? @default(false)

  // reference other collections
  taskLogList  taskLog[]


  // for Fitbit
  fitbitId String?
  fitbitDisplayName String?
  fitbitFullName String?
  accessToken String?
  refreshToken String?

  // for Fitbit subscription
  fitbitUpdateList fitbit_subscription[]

  // for survey response
  responseList response[]

  // for user preference
  weekdayWakeup DateTime?
  weekdayBed DateTime?
  weekendWakeup DateTime?
  weekendBed DateTime?


  // for time
  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
}


model response {
  id  String  @id @default(auto()) @map("_id") @db.ObjectId

  // for survey response
  participantId String
  surveyId String?
  surveyLink String
  surveyParamsString String?
  content  String

  // connect to users collection
  participant    users    @relation(fields: [participantId], references: [fitbitId])



  // for time
  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
}

model fitbit_subscription {

  id  String  @id @default(auto()) @map("_id") @db.ObjectId

  
  // for subscription notification from Fitbit
  collectionType String
  date String
  ownerId String
  ownerType String
  subscriptionId String


  // connect to users collection
  owner    users    @relation(fields: [ownerId], references: [fitbitId])

  // for query data: notification -> processed
  status String @default("notification")

  // for security logging
  ip String?

  

  // for time
  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
}

model message {
  id  String  @id @default(auto()) @map("_id") @db.ObjectId

  // for message
  label String @unique
  group String
  groupIndex Int
  interventionMessage  String?
  walkMessage String?
  gif String?
  timeOfDay String?
  topic String?
  sampleMessage String?
  note String?

  // reference other collections
  taskLogList  taskLog[]


  // for time
  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
}

model task {
  id  String  @id @default(auto()) @map("_id") @db.ObjectId

  // for task
  label String @unique
  index Int?
  enabled Boolean? @default(false)
  checkPoint Json
  group Json
  randomization Json
  preCondition Json?

  // reference other collections
  taskLogList  taskLog[]

  // for time
  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
}


model taskLog {
  id  String  @id @default(auto()) @map("_id") @db.ObjectId

  // for task
  task    task    @relation(fields: [taskLabel], references: [label])
  taskLabel String

  // for user
  user    users    @relation(fields: [username], references: [username])
  username String

  // caching user info
  userInfoCache Json?

  // for action
  randomizationResult Json

  // for message, possibly none if no action or action that does not invovle message
  message    message?    @relation(fields: [messageLabel], references: [label])
  messageLabel String?

  
  // for execution
  executionResult Json?
  
  // for time
  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt
}
